// HealthLink Pro v2.0 - Prisma Schema
// Purpose: Type-safe database layer for user authentication and audit logging
// Database: Supabase PostgreSQL (OFF-CHAIN user data only)
// Medical Records: Stored on Hyperledger Fabric blockchain (separate system)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// Enums - Type-Safe Status and Type Values
// ============================================================================

enum Role {
  PATIENT
  DOCTOR
  ADMIN
  GOVERNMENT
  LAB
  
  @@map("role")
}

enum DoctorVerificationStatus {
  PENDING
  VERIFIED
  SUSPENDED
  
  @@map("doctor_verification_status")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  CANCELLED
  EXPIRED
  
  @@map("invitation_status")
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
  
  @@map("appointment_status")
}

enum PrescriptionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  
  @@map("prescription_status")
}

enum RecordType {
  DIAGNOSIS
  TREATMENT
  PRESCRIPTION
  LAB_RESULT
  IMAGING
  OTHER
  
  @@map("record_type")
}

enum ConsentStatus {
  PENDING
  APPROVED
  DENIED
  REVOKED
  
  @@map("consent_status")
}

enum LabTestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  
  @@map("lab_test_status")
}

enum AuditAction {
  DATA_ACCESS
  DATA_CREATE
  DATA_UPDATE
  DATA_DELETE
  CONSENT_GRANTED
  CONSENT_REVOKED
  LOGIN
  LOGOUT
  EXPORT_DATA
  SHARE_DATA
  EMERGENCY_ACCESS
  
  @@map("audit_action")
}

enum ResourceType {
  PATIENT_RECORD
  MEDICAL_RECORD
  PRESCRIPTION
  APPOINTMENT
  LAB_TEST
  CONSENT_REQUEST
  USER_PROFILE
  INSURANCE_CLAIM
  
  @@map("resource_type")
}

// ============================================================================
// User Model - Authentication and Profile Metadata
// ============================================================================
model User {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid

  // Authentication Fields
  email        String  @unique @db.VarChar(255)
  passwordHash String  @map("password_hash") @db.Text
  
  // Role-Based Access Control (stored as varchar in DB)
  role String @default("patient") @db.VarChar(50)
  
  // Hyperledger Fabric Integration
  fabricEnrollmentId String @unique @map("fabric_enrollment_id") @db.VarChar(255)
  
  // User Profile Metadata
  fullName    String  @map("full_name") @db.VarChar(255)
  phoneNumber String? @map("phone") @db.VarChar(20)
  avatarUrl   String? @map("avatar_url") @db.Text
  
  // Additional Profile Fields (from DB schema)
  gender      String? @db.VarChar(50)
  address     String? @db.Text
  
  // Doctor-Specific Fields (NULL for non-doctors)
  doctorLicenseNumber         String? @map("license_number") @db.VarChar(100)
  doctorSpecialization        String? @map("specialization") @db.VarChar(100)
  doctorHospitalAffiliation   String? @map("doctor_hospital_affiliation") @db.VarChar(255)
  doctorVerificationStatus    String? @map("doctor_verification_status") @db.VarChar(50)
  qualification               String? @db.Text
  experienceYears             Int?    @map("experience_years")
  consultationFee             Decimal? @map("consultation_fee") @db.Decimal(10, 2)
  
  // Patient-Specific Fields (NULL for non-patients)
  patientDateOfBirth      DateTime? @map("date_of_birth") @db.Date
  patientBloodGroup       String?   @map("blood_group") @db.VarChar(10)
  patientEmergencyContact String?   @map("emergency_contact") @db.VarChar(20)
  
  // Account Status
  isActive      Boolean @default(true) @map("is_active")
  emailVerified Boolean @default(false) @map("email_verified")
  
  // Security: Admin can flag suspicious accounts
  flagged Boolean @default(false) @map("flagged")
  flaggedReason String? @map("flagged_reason") @db.Text
  flaggedAt DateTime? @map("flagged_at") @db.Timestamptz(6)
  flaggedBy String? @map("flagged_by") @db.Uuid
  
  // Phase 1: Two-Factor Authentication
  twoFactorSecret String? @map("two_factor_secret") @db.Text
  twoFactorEnabled Boolean @default(false) @map("two_factor_enabled")
  backupCodes String[] @map("backup_codes") @default([])
  
  // Phase 1: Hospital Affiliation (for doctors/staff)
  hospitalId String? @map("hospital_id") @db.Uuid
  hospital Hospital? @relation(fields: [hospitalId], references: [id], onDelete: SetNull)
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamptz(6)
  
  // Relations
  auditLogs UserAuditLog[]
  sentInvitations UserInvitation[] @relation("SentInvitations")
  
  // Doctor Relations
  doctorAppointments Appointment[] @relation("DoctorAppointments")
  doctorPrescriptions Prescription[] @relation("DoctorPrescriptions")
  doctorRecords MedicalRecord[] @relation("DoctorRecords")
  doctorLabTests LabTest[] @relation("DoctorLabTests")
  createdPatientMappings PatientWalletMapping[] @relation("CreatedPatientMappings")
  
  // Consent Relations
  consentRequests ConsentRequest[] @relation("ConsentRequests")
  
  // Lab Relations
  // Lab Relations
  labTests LabTest[] @relation("LabTests")
  
  // Patient Profile Link
  patientProfile PatientWalletMapping? @relation("LinkedPatientProfile")
  
  // Chat Messages
  chatMessages ChatMessage[] @relation("UserChatMessages")
  
  // Audit and Compliance Relations
  auditActions AuditLog[] @relation("UserAuditActions")
  complianceReports ComplianceReport[] @relation("UserComplianceReports")
  
  @@index([email], name: "idx_users_email")
  @@index([role], name: "idx_users_role")
  @@index([fabricEnrollmentId], name: "idx_users_fabric_enrollment_id")
  @@index([createdAt(sort: Desc)], name: "idx_users_created_at")
  @@map("users")
}

// ============================================================================
// UserAuditLog Model - Authentication Event Tracking
// ============================================================================
model UserAuditLog {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Foreign Key to User
  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Audit Event Details
  action    String  @db.VarChar(50)
  ipAddress String? @map("ip_address") @db.Inet
  userAgent String? @map("user_agent") @db.Text
  
  // Timestamp
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  @@index([userId], name: "idx_audit_user_id")
  @@index([createdAt(sort: Desc)], name: "idx_audit_created_at")
  @@map("user_audit_log")
}

// ============================================================================
// UserInvitation Model - Admin-Managed User Registration
// ============================================================================
model UserInvitation {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Invitation Details
  email String @db.VarChar(255)
  role String @db.VarChar(50)
  token String @unique @db.VarChar(255)
  status String @default("pending") @db.VarChar(50)
  
  // Invitation Metadata
  invitedBy String? @map("invited_by") @db.Uuid
  invitedByUser User? @relation("SentInvitations", fields: [invitedBy], references: [id], onDelete: SetNull)
  
  // Expiration
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([email], name: "idx_user_invitations_email")
  @@index([token], name: "idx_user_invitations_token")
  @@index([status], name: "idx_user_invitations_status")
  @@index([expiresAt], name: "idx_user_invitations_expires_at")
  @@map("user_invitations")
}

// ============================================================================
// PatientWalletMapping Model - Email to Wallet Address Mapping
// ============================================================================
model PatientWalletMapping {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid

  // Patient Email (unique identifier)
  email String @unique @db.VarChar(255)

  // Blockchain Wallet Address
  walletAddress String @unique @map("wallet_address") @db.VarChar(42)

  // Patient Basic Info
  name String @db.VarChar(255)

  // Doctor who created this mapping
  createdBy String @map("created_by") @db.Uuid
  createdByUser User @relation("CreatedPatientMappings", fields: [createdBy], references: [id], onDelete: Cascade)

  // Link to User Account (The missing field!)
  userId String? @unique @map("user_id") @db.Uuid
  user   User?   @relation("LinkedPatientProfile", fields: [userId], references: [id], onDelete: Cascade)

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  appointments Appointment[]
  prescriptions Prescription[]
  medicalRecords MedicalRecord[]
  consentRequests ConsentRequest[]
  labTests LabTest[]
  
  // Phase 1: Insurance Relations
  insurancePolicies InsurancePolicy[]

  @@index([email], name: "idx_patient_wallet_email")
  @@index([walletAddress], name: "idx_patient_wallet_address")
  @@index([createdBy], name: "idx_patient_wallet_created_by")
  @@index([userId], name: "idx_patient_wallet_user_id")
  @@map("patient_wallet_mappings")
}

// ============================================================================
// Appointment Model - Doctor-Patient Appointments
// ============================================================================
model Appointment {
  // Primary Key
  id String @id @default(uuid()) @db.Text

  // Appointment Details
  appointmentId String @unique @map("appointment_id") @db.VarChar(255)
  title String @db.VarChar(255)
  description String? @db.Text
  scheduledAt DateTime @map("scheduled_at") @db.Timestamptz(6)
  status String @default("SCHEDULED") @db.VarChar(50)

  // Relationships
  patientId String @map("patient_id") @db.Uuid
  patient PatientWalletMapping @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String @map("doctor_id") @db.Uuid
  doctor User @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Cascade)

  // Additional Details
  notes String? @db.Text
  location String? @db.VarChar(255)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([appointmentId], name: "idx_appointments_appointment_id")
  @@index([patientId], name: "idx_appointments_patient_id")
  @@index([doctorId], name: "idx_appointments_doctor_id")
  @@index([scheduledAt], name: "idx_appointments_scheduled_at")
  @@map("appointments")
}

// ============================================================================
// Prescription Model - Doctor-Patient Prescriptions
// ============================================================================
model Prescription {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid

  // Prescription Details
  prescriptionId String @unique @map("prescription_id") @db.VarChar(255)
  medication String @db.VarChar(255)
  dosage String @db.VarChar(100)
  instructions String? @db.Text
  expiryDate DateTime? @map("expiry_date") @db.Timestamptz(6)
  status String @default("ACTIVE") @db.VarChar(50)

  // Relationships
  patientId String @map("patient_id") @db.Uuid
  patient PatientWalletMapping @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String @map("doctor_id") @db.Uuid
  doctor User @relation("DoctorPrescriptions", fields: [doctorId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([prescriptionId], name: "idx_prescriptions_prescription_id")
  @@index([patientId], name: "idx_prescriptions_patient_id")
  @@index([doctorId], name: "idx_prescriptions_doctor_id")
  @@map("prescriptions")
}

// ============================================================================
// MedicalRecord Model - Patient Medical Records
// ============================================================================
model MedicalRecord {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid

  // Record Details
  recordId String @unique @map("record_id") @db.VarChar(255)
  title String @db.VarChar(255)
  description String? @db.Text
  recordType String @map("record_type") @db.VarChar(50)
  ipfsHash String @map("ipfs_hash") @db.VarChar(255)
  fileName String? @map("file_name") @db.VarChar(255)

  // Relationships
  patientId String @map("patient_id") @db.Uuid
  patient PatientWalletMapping @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String @map("doctor_id") @db.Uuid
  doctor User @relation("DoctorRecords", fields: [doctorId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([recordId], name: "idx_medical_records_record_id")
  @@index([patientId], name: "idx_medical_records_patient_id")
  @@index([doctorId], name: "idx_medical_records_doctor_id")
  @@map("medical_records")
}

// ============================================================================
// ConsentRequest Model - Patient Consent Requests
// ============================================================================
model ConsentRequest {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid

  // Consent Details
  consentId String @unique @map("consent_id") @db.VarChar(255)
  purpose String @db.Text
  scope String @db.VarChar(100)
  status String @default("PENDING") @db.VarChar(50)
  validUntil DateTime @map("valid_until") @db.Timestamptz(6)

  // Relationships
  patientId String @map("patient_id") @db.Uuid
  patient PatientWalletMapping @relation(fields: [patientId], references: [id], onDelete: Cascade)

  requesterId String @map("requester_id") @db.Uuid
  requester User @relation("ConsentRequests", fields: [requesterId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  // Relations
  auditLogs AuditLog[] @relation("ConsentAuditLogs")

  @@index([consentId], name: "idx_consent_requests_consent_id")
  @@index([patientId], name: "idx_consent_requests_patient_id")
  @@index([requesterId], name: "idx_consent_requests_requester_id")
  @@map("consent_requests")
}

// ============================================================================
// LabTest Model - Laboratory Test Results
// ============================================================================
model LabTest {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid

  // Test Details
  testId String @unique @map("test_id") @db.VarChar(255)
  testName String @map("test_name") @db.VarChar(255)
  testType String @map("test_type") @db.VarChar(100)
  results String? @db.Text
  status String @default("PENDING") @db.VarChar(50)
  performedAt DateTime? @map("performed_at") @db.Timestamptz(6)

  // Relationships
  patientId String @map("patient_id") @db.Uuid
  patient PatientWalletMapping @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String @map("doctor_id") @db.Uuid
  doctor User @relation("DoctorLabTests", fields: [doctorId], references: [id], onDelete: Cascade)

  labId String? @map("lab_id") @db.Uuid
  lab User? @relation("LabTests", fields: [labId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([testId], name: "idx_lab_tests_test_id")
  @@index([patientId], name: "idx_lab_tests_patient_id")
  @@index([doctorId], name: "idx_lab_tests_doctor_id")
  @@map("lab_tests")
}

// ============================================================================
// Chat Messages - LangGraph Agent Conversation History
// ============================================================================

model ChatMessage {
  id String @id @default(uuid()) @db.Uuid
  
  // User relationship
  userId String @map("user_id") @db.Uuid
  user User @relation("UserChatMessages", fields: [userId], references: [id], onDelete: Cascade)
  
  // Message role
  role String @db.VarChar(20) // 'user' or 'assistant'
  
  // Message content
  content String @db.Text
  
  // Thread management
  threadId String @map("thread_id") @db.VarChar(255)
  
  // Metadata (JSON)
  metadata String? @db.Text
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  @@index([userId], name: "idx_chat_messages_user_id")
  @@index([threadId], name: "idx_chat_messages_thread_id")
  @@index([createdAt], name: "idx_chat_messages_created_at")
  @@map("chat_messages")
}

// ============================================================================
// Phase 1: Hospital Management Models
// ============================================================================

model Hospital {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Hospital Details
  name String @db.VarChar(255)
  registrationNumber String @unique @map("registration_number") @db.VarChar(100)
  type String @db.VarChar(50) // Government, Private, Specialty
  address String @db.Text
  phone String? @db.VarChar(20)
  email String? @db.VarChar(255)
  isActive Boolean @default(true) @map("is_active")
  
  // Relations
  departments Department[]
  staff User[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([registrationNumber], name: "idx_hospitals_registration")
  @@map("hospitals")
}

model Department {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Department Details
  name String @db.VarChar(255)
  description String? @db.Text
  
  // Hospital Relation
  hospitalId String @map("hospital_id") @db.Uuid
  hospital Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // Head Doctor (optional)
  headDoctorId String? @map("head_doctor_id") @db.Uuid
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([hospitalId], name: "idx_departments_hospital_id")
  @@map("departments")
}

// ============================================================================
// Phase 1: Pharmacy Models
// ============================================================================

model Pharmacy {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Pharmacy Details
  name String @db.VarChar(255)
  licenseNumber String @unique @map("license_number") @db.VarChar(100)
  address String @db.Text
  phone String? @db.VarChar(20)
  email String? @db.VarChar(255)
  isActive Boolean @default(true) @map("is_active")
  
  // Relations
  inventory DrugInventory[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([licenseNumber], name: "idx_pharmacies_license")
  @@map("pharmacies")
}

model DrugInventory {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Pharmacy Relation
  pharmacyId String @map("pharmacy_id") @db.Uuid
  pharmacy Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  
  // Drug Details
  drugName String @map("drug_name") @db.VarChar(255)
  batchNumber String @map("batch_number") @db.VarChar(100)
  quantity Int
  expiryDate DateTime @map("expiry_date") @db.Date
  manufacturer String? @db.VarChar(255)
  pricePerUnit Decimal? @map("price_per_unit") @db.Decimal(10, 2)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([pharmacyId], name: "idx_drug_inventory_pharmacy_id")
  @@index([expiryDate], name: "idx_drug_inventory_expiry")
  @@map("drug_inventory")
}

// ============================================================================
// Phase 1: Insurance Models
// ============================================================================

model InsuranceProvider {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Provider Details
  name String @db.VarChar(255)
  registrationNumber String @unique @map("registration_number") @db.VarChar(100)
  contactEmail String @map("contact_email") @db.VarChar(255)
  contactPhone String? @map("contact_phone") @db.VarChar(20)
  isActive Boolean @default(true) @map("is_active")
  
  // Relations  
  policies InsurancePolicy[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([registrationNumber], name: "idx_insurance_providers_registration")
  @@map("insurance_providers")
}

model InsurancePolicy {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Policy Details
  policyNumber String @unique @map("policy_number") @db.VarChar(100)
  coverageAmount Decimal @map("coverage_amount") @db.Decimal(10, 2)
  validFrom DateTime @map("valid_from") @db.Date
  validUntil DateTime @map("valid_until") @db.Date
  isActive Boolean @default(true) @map("is_active")
  
  // Provider Relation
  providerId String @map("provider_id") @db.Uuid
  provider InsuranceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  // Patient Relation
  patientId String @map("patient_id") @db.Uuid
  patient PatientWalletMapping @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  // Relations
  claims InsuranceClaim[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([policyNumber], name: "idx_insurance_policies_number")
  @@index([patientId], name: "idx_insurance_policies_patient_id")
  @@map("insurance_policies")
}

model InsuranceClaim {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Blockchain Reference
  claimId String @unique @map("claim_id") @db.VarChar(255)
  blockchainTxHash String? @map("blockchain_tx_hash") @db.VarChar(66)
  
  // Claim Details
  claimedAmount Decimal @map("claimed_amount") @db.Decimal(10, 2)
  approvedAmount Decimal? @map("approved_amount") @db.Decimal(10, 2)
  status String @default("SUBMITTED") @db.VarChar(50) // SUBMITTED, VERIFIED, APPROVED, REJECTED, PAID
  
  // Policy Relation
  policyId String @map("policy_id") @db.Uuid
  policy InsurancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  
  // Provider (Hospital/Doctor who submitted)
  providerId String @map("provider_id") @db.Uuid
  
  // Supporting Documents (IPFS hashes)
  supportingDocs String[] @map("supporting_docs")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([claimId], name: "idx_insurance_claims_claim_id")
  @@index([policyId], name: "idx_insurance_claims_policy_id")
  @@index([status], name: "idx_insurance_claims_status")
  @@map("insurance_claims")
}

// ============================================================================
// Phase 1: System Audit Log (separate from UserAuditLog)
// ============================================================================

model SystemAuditLog {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // User (optional - system actions may not have user)
  userId String? @map("user_id") @db.Uuid
  
  // Action Details
  action String @db.VarChar(100) // DATA_ACCESS, CONSENT_GRANT, BLOCKCHAIN_TX, etc.
  resourceType String @map("resource_type") @db.VarChar(50) // PATIENT_RECORD, PRESCRIPTION, etc.
  resourceId String? @map("resource_id") @db.VarChar(255)
  
  // Metadata
  metadata Json? // Additional context (flexible JSON)
  ipAddress String? @map("ip_address") @db.Inet
  userAgent String? @map("user_agent") @db.Text
  
  // Timestamp
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  @@index([userId], name: "idx_system_audit_user_id")
  @@index([action], name: "idx_system_audit_action")
  @@index([resourceType], name: "idx_system_audit_resource_type")
  @@index([createdAt(sort: Desc)], name: "idx_system_audit_created_at")
  @@map("system_audit_logs")
}

// ============================================================================
// Phase 1: Compliance Audit Log (separate from SystemAuditLog)
// ============================================================================

model AuditLog {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // User  
  userId String @map("user_id") @db.Uuid
  user User @relation("UserAuditActions", fields: [userId], references: [id], onDelete: Cascade)
  
  // Action Details
  action String @db.VarChar(100) // Using string instead of enum for database compatibility
  resourceType String @map("resource_type") @db.VarChar(50)
  resourceId String @map("resource_id") @db.Uuid
  
  // Additional Context
  details Json? // Additional context
  timestamp DateTime @default(now()) @db.Timestamptz(6)
  ipAddress String? @map("ip_address") @db.Inet
  userAgent String? @map("user_agent") @db.Text
  
  // Compliance Flags
  emergency Boolean @default(false)
  consentId String? @map("consent_id") @db.Uuid
  consent ConsentRequest? @relation("ConsentAuditLogs", fields: [consentId], references: [id], onDelete: SetNull)
  blockchainHash String? @map("blockchain_hash") @db.VarChar(255)
  
  // Status
  success Boolean @default(true)
  errorMessage String? @map("error_message") @db.Text
  
  @@index([userId], name: "idx_audit_logs_user_id")
  @@index([timestamp], name: "idx_audit_logs_timestamp")
  @@index([action], name: "idx_audit_logs_action")
  @@map("audit_logs")
}

model ComplianceReport {
  // Primary Key
  id String @id @default(uuid()) @db.Uuid
  
  // Report Details
  reportType String @map("report_type") @db.VarChar(50) // HIPAA, GDPR, etc.
  startDate DateTime @map("start_date") @db.Timestamptz(6)
  endDate DateTime @map("end_date") @db.Timestamptz(6)
  
  // Generated By
  generatedBy String @map("generated_by") @db.Uuid
  generatedByUser User @relation("UserComplianceReports", fields: [generatedBy], references: [id], onDelete: Cascade)
  generatedAt DateTime @default(now()) @map("generated_at") @db.Timestamptz(6)
  
  // Report Data
  totalRecords Int @map("total_records")
  violationsCount Int @map("violations_count")
  reportData Json @map("report_data")
  fileUrl String? @map("file_url") @db.Text
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([reportType], name: "idx_compliance_reports_type")
  @@index([generatedAt], name: "idx_compliance_reports_generated_at")
  @@map("compliance_reports")
}
